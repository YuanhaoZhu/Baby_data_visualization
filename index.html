<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://d3js.org/d3-collection.v1.min.js"></script>
  <script src="https://unpkg.com/d3-simple-slider"></script>
  <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pangolin&display=swap');
    html{
      font-family: 'Pangolin', cursive;
    }

    div{
      font-family: 'Pangolin', cursive;
    }

    body{
      background-color: #FAF8F3
    }

    text{
      font-family: 'Pangolin', cursive;
      font-size: 14px;
    }

    text.title{
      font-family: 'Pangolin', cursive;
      font-size: 20px;
    }


    text.bubbleTitle{
      font-family: 'Pangolin', cursive;
      font-size: 20px;
    }
    #bbtitle{
      font-size:20px;
      margin-top:-6px;
    }

    .vizTitle{
      margin-top: 40px;
    }


    .face{
      height: 250px;
      width: 314px;
      background-size: cover;
      margin-left: 20px;
      margin-right: 20px;

    }

    .eye {
      border-radius: 22px;
      /*top:55px;*/
      /*margin-top: 1em;*/
      height: 22px;
      width: 22px;
      display: inline-block;

      text-align: center;
      position: relative;
      background: #FFF;
    }

    #right1{
      left:25px;
      top:70px;
    }
    #left1{
      left:90px;
      top:70px;
    }


    #right2{
      left:116px;
      top:48px;
    }
    #left2{
      left:182px;
      top:48px;
    }
    #right2.eye::after{
      background: #96C0FF
    }
    #left2.eye::after{
      background: #96C0FF
    }

    #right3{
      left:26px;
      top:49px;
    }
    #left3{
      left:92px;
      top:49px;
    }

    #right4{
      left:113px;
      top:64px;
    }
    #left4{
      left:180px;
      top:64px;
    }
    #right4.eye::after{
      background: grey
    }
    #left4.eye::after{
      background: grey
    }


    .eye.animate {
      transition: all 100ms;
    }

    .eye:after {
      content: " ";
      /*eye to eyewhite distance*/
      bottom: 1px;
      right: 1px;
      position: absolute;
      width: 15px;
      height: 15px;
      background: #50280D;
      border-radius: 15px;
    }

    #animate {
      outline: none;
      background: #FFF;
      border: solid thin #000;
      padding: 1px;
      margin: 1px;
      position: absolute;
      top: 5px;
      right: 5px;
      color: #50280D;
      transition: all 300ms;
      cursor: pointer;
    }

    #animate:hover {
      background: #000;
      color: #FFF;
      border: solid thin white;
    }


    .sticky {
      position: fixed;
      top: 0;
      width: 100%;}




    .slider{
    display: flex;
    justify-content: center;
    }

    .linechart{
      display: flex;
      justify-content: flex-start;
      margin-left: 70px
    }
    .bubble{
      /* display: inline-block; */
      display: flex;
      justify-content: center;
      align-items: center;
      vertical-align: middle;
      top: 10px;
      left:30px;
      flex-direction: column;


    }
    .bar{
      display: flex;
      justify-content: center;
      right:10px;
    }

    .my-legend{
      display: flex;
      justify-content: center;
      top:65px;
      left:430px;
    }
    .slidecontainer{
      display: flex;
      justify-content: flex-start;
      margin-bottom: 50px;
      margin-left: 140px;

    }
    .my-legendA{
      display: flex;
      justify-content: center;
      top:65px;
      left:430px;
    }
    .barandBubble{
      display: flex;
      justify-content: center;
    }

    span {
    display: block;
    float: left;
    border:none;
    width: 25%;
    }

    .my-legend .legend-title {
    text-align: left;
    margin-bottom: 8px;
    font-weight: bold;
    /*font-size: 90%;*/
    }
  .my-legend .legend-scale ul {
    margin: 0;
    padding: 0;
    float: left;
    list-style: none;
    }
  .my-legend .legend-scale ul li {
    display: block;
    float: left;
    width: 110px;
    margin-bottom: 6px;
    text-align: center;
    /*font-size: 80%;*/
    list-style: none;
    }
  .my-legend ul.legend-labels li span {
    display: block;
    float: left;
    height: 15px;
    width: 110px;
    }

  .my-legend a {
    color: #777;
    }


    .my-legendA .legend-titleA {
    text-align: left;
    margin-bottom: 8px;
    font-weight: bold;
    /*font-size: 90%;*/
    }
  .my-legendA .legend-scaleA ul {
    margin: 0;
    padding: 0;
    float: left;
    list-style: none;
    }
  .my-legendA .legend-scaleA ul li {
    display: block;
    float: left;
    width: 50px;
    margin-bottom: 6px;
    text-align: center;
    /*font-size: 80%;*/
    list-style: none;
    }
  .my-legendA ul.legend-labelA li span {
    display: block;
    float: left;
    height: 15px;
    width: 50px;
    }

  .my-legendA a {
    color: #777;
    }

  .gridlines line {
      stroke: #bbb;
    }

  .gridlines .domain {
      stroke: none;
    }

  .userName{
    display: flex;
    justify-content: flex-start;
    /* margin-left: 50px; */
  }
  .col-sm-4{
    margin-top: 20px;
  }
  .rankSlector{
    display: flex;
    justify-content: flex-start;
    margin-left: 20px;
    margin-bottom: 30px;

  }

  </style>
</head>
<body>

  <div class='vizTitle' style="text-align:center;">
    <h1>Baby Names and Births in NYC</h1>
  </div>

  <div style="padding-left:200px; padding-right:200px;">
    <p>Choosing a perfect name for your future baby can be an important decision. Should you choose a modern and popular name, should you pick a traditional name that will stand the test of time, or should you select a very unique name?</p>
    <p>Fortunately, we made interactive data visualization to help you choose the perfect name for your future baby. </p>
    <ul>
      <li>Colors in all visualizations are consistently representing ethnicity and gender with the <a href="#legendhere">legend</a> shown below.</li>
      <li>Enter a name in the dialogue box and hit "Send" to see the trend of this name over years in the <a href="#linechart">line chart.</a></li>
      <li><a href="#sticky">Choose a rank</a> from the drop-down menu to see the top-N popular baby names in the bubble chart. </li>
      <li><a href="#sticky">Slide through different years</a> to see how the popular names change throughout time. The number of newborn babies from different ethnicity will be updated accordingly. </li>
      <li><a href="#bubbleGraph">Click on the bubble</a> to see the trend of popularity for that name with the specific ethnicity.</li>
      <li>Move mouse around babies <b style="font-size: 30px">&#128118;&#127995; &#128118;&#127996; &#128118;&#127997; &#128118;&#127998;</b> to see suprise <b style="font-size: 30px">&#127882;</b></li>
    </ul>
    <p>Data were collected through the civil birth registration of New York City from 2011 to 2017.</p>

  </div>

  <div id="project_container">
    <div class="row" id="projectbox">
      <div class="col-sm-4">
        <div class='face' id= 'leftbaby' style="background-image: url('leftbaby.png');">
          <div class='eye' id="left1"></div>
          <div class='eye' id="right1"></div>
          <div class='eye' id="left2"></div>
          <div class='eye' id="right2"></div>
        </div>
      </div>

    <div class="col-sm-4">
      <div id="legendhere" class='my-legend' text-align="center">
          <div class='legend-title'></div>
          <div class='legend-scale'>
            <ul class='legend-labels'>
              <li><span style='background:#FEF1E2;'></span>White Non Hispanic</li>
              <li><span style='background:#E28E51;'></span>Hispanic</li>
              <li><span style='background:#934914;'></span>Black Non Hispanic</li>
              <li><span style='background:#FDDEBB;'></span>Asian and Pacific Islander</li>
              <li><span style='background:#687980;'></span>other</li>
              <!-- <li><span></span></li>
              <li><span style='background:#99ccff;'></span>Male</li>
              <li><span style='background:#ffc0cb;'></span>Female</li> -->
            </ul>
            <ul class='legend-labels'>
              <li><span style='background:#99ccff;'></span>Male</li>
              <li><span style='background:#ffc0cb;'></span>Female</li>
            </ul>
          </div>
          </div>
          </div>


        <!-- <div style="background-image: url('2.png');background-width:200px;background-repeat: no-repeat; padding:10px">
          <h3 style="text-align: left; padding: 5px;margin-left: 30px;">What's your name?</h3> -->
          <!-- <h3 style="text-align: left;">My name is</h3> -->

        <!-- </div> -->

      <!-- </div> -->

      <div class="col-sm-4">
        <div class='face' id= 'rightbaby' style="background-image: url('rightbaby.png');">
          <div class='eye' id="left3"></div>
          <div class='eye' id="right3"></div>
          <div class='eye' id="left4"></div>
          <div class='eye' id="right4"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- <div id="legendhere" class='my-legend' text-align="center">
      <div class='legend-title'></div>
      <div class='legend-scale'>
        <ul class='legend-labels'>
          <li><span style='background:#FEF1E2;'></span>White Non Hispanic</li>
          <li><span style='background:#E28E51;'></span>Hispanic</li>
          <li><span style='background:#934914;'></span>Black Non Hispanic</li>
          <li><span style='background:#FDDEBB;'></span>Asian and Pacific Islander</li>
          <li><span style='background:#687980;'></span>other</li>
          <li><span></span></li>
          <li><span style='background:#99ccff;'></span>Male</li>
          <li><span style='background:#ffc0cb;'></span>Female</li>
        </ul>
      </div>
      </div> -->



<!--   <div class='my-legendA' text-align="center">
  <div class='legend-titleA'></div>
  <div class='legend-scaleA'>
    <ul class='legend-labelA'>
      <li><span style='background:#99ccff;'></span>Male</li>
      <li><span style='background:#ffc0cb;'></span>Female</li>
    </ul>
  </div>
  </div> -->

  <!-- <div id="sticky" style="background-color:#FAF8F3; padding-top: 20px"> -->
    <div class= "slider" id="yearSlider" > </div>
   <!--  <div class="rankSlector" style="margin-left: 200px;margin-bottom: 10px">
      <h5>Choose a rank
       <select id="selectRank"><option value="none" selected disabled hidden>Select</option></select></h5>
    </div> -->
    <div class="rankSlector" style="margin-left: 200px;margin-bottom: 10px">
    <h5>Choose a rank
       <select id="selectRank"><option value="none" selected disabled hidden>Select</option></select></h5><h5 style="margin-left: 40px"></h5>
  </div>

 <!--  <div class="slidecontainer">
    <div class="rankSlector">
      <text>Choose a rank</text>
     <select id="selectRank"><option value="none" selected disabled hidden>Select</option></select>
    </div>
  </div> -->



<div class="barandBubble">
  <div class="bubble" >
    <text id="bbtitle">Popular Baby Names</text>
    <svg id="bubbleGraph" height="350" width="800">
    </svg>
  </div>



  <div class="bar">
    <svg id="barChart" width="600" height="300"></svg>
  </div>

</div>

<div id="linechart"class="linechart">
  <div class="userName" style="background-image: url('1.png');background-width:50px;background-repeat: no-repeat; padding:10px">
    <h3 style="text-align: left; padding: 5px;margin-right: 30px;">Try your name <input type="text" placeholder="e.g.James" id="myInput" style="width: 130px"></h3>
    <div style="text-align: right">
      <button id="sendButton"type="button" onclick="location.href='#linechart'">Send</button>
    </div>
  <div class="line" text-align="center"><svg id="lineGraph" width="600" height="400" style="background: #sff; " ></svg></div>
</div>

  <script>
    //source:https://codepen.io/iaks/full/VeBJEP
    $("#projectbox").mousemove(function(event) {
      var eye = $("#leftbaby .eye");
      var x = (eye.offset().left) + (eye.width() / 2);
      var y = (eye.offset().top) + (eye.height() / 2);
      var rad = Math.atan2(event.pageX - x, event.pageY - y);
      var rot = (rad * (180 / Math.PI) * -1) + 0;
      eye.css({
        '-webkit-transform': 'rotate(' + rot + 'deg)',
        '-moz-transform': 'rotate(' + rot + 'deg)',
        '-ms-transform': 'rotate(' + rot + 'deg)',
        'transform': 'rotate(' + rot + 'deg)'
  });
});

    $("#projectbox").mousemove(function(event) {
      var eye = $("#rightbaby .eye");
      var x = (eye.offset().left) + (eye.width() / 2);
      var y = (eye.offset().top) + (eye.height() / 2);
      var rad = Math.atan2(event.pageX - x, event.pageY - y);
      var rot = (rad * (180 / Math.PI) * -1) + 0;
      eye.css({
        '-webkit-transform': 'rotate(' + rot + 'deg)',
        '-moz-transform': 'rotate(' + rot + 'deg)',
        '-ms-transform': 'rotate(' + rot + 'deg)',
        'transform': 'rotate(' + rot + 'deg)'
  });
});




  	const bubbleLayer = d3.select("#bubbleGraph").append("g");
  	const bubbleLegend = d3.select("#bubbleGraph").append("g");

    const bubbleWidth = d3.select("#bubbleGraph").attr("width");
    const bubbleHeight = d3.select("#bubbleGraph").attr("height");
    const bubblePadding = 50
    const bubblePaddedHeight = bubbleHeight - 2*bubblePadding
    const bubblePaddedWidth = bubbleWidth - 2*bubblePadding

    const barLayer = d3.select("#barChart").append("g");
    const barLegend = d3.select("#barChart").append("g");
    const barWidth = d3.select("#barChart").attr("width");
    const barHeight = d3.select("#barChart").attr("height");
    const barPadding = 30
    const barChartHeight = barHeight - 2*barPadding
    const barChartWidth = barWidth - 2*barPadding

    const lineLegend = d3.select("#lineGraph").append("g");
    const lineLayer = d3.select("#lineGraph").append("g");
    const lineWidth = d3.select("#lineGraph").attr("width");
    const lineHeight = d3.select("#lineGraph").attr("height");
    const linePadding = 50
    const lineChartHeight = lineHeight - 2*linePadding
    const lineChartWidth = lineWidth - 2*linePadding





    const requestData = async () => {
      //set default
      var chosenYear = 2017
      var rank = 3
      var chosenName = "ISABELLA"
      var chosenEthnicity = "HISPANIC"
      var chosenGender = "FEMALE"

      function capitalize(string) {
          return string.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
      }

      var bbnames = await d3.csv("Popular_Baby_Names.csv", d3.autoType)

      bbnames.forEach( d => {
        d["Child's First name"]= d["Child's First name"].toUpperCase()
      });
      //console.log(bbnames)
      const natality = await d3.csv('Natality.csv');
      //console.log(natality)

      var nameLineData = bbnames.filter((d)=>{return (d['Year of Birth']>= 2011)
                                                    && d["Child's First name"]=== chosenName
                                                    && d["Ethnicity"]=== chosenEthnicity
                                                    && d['Gender']=== chosenGender
                                                  });

      var hispanicLineData = bbnames.filter((d)=>{return (d['Year of Birth']>= 2011)
                                                    && d["Child's First name"]=== chosenName
                                                    && d["Ethnicity"]=== "HISPANIC"
                                                    && d['Gender']=== chosenGender
                                                  });

      var asianLineData = bbnames.filter((d)=>{return (d['Year of Birth']>= 2011)
                                                    && d["Child's First name"]=== chosenName
                                                    && d["Ethnicity"]=== "ASIAN AND PACIFIC ISLANDER"
                                                    && d['Gender']=== chosenGender
                                                  });
      var blackLineData = bbnames.filter((d)=>{return (d['Year of Birth']>= 2011)
                                                    && d["Child's First name"]=== chosenName
                                                    && d["Ethnicity"]=== "BLACK NON HISPANIC"
                                                    && d['Gender']=== chosenGender
                                                  });
      var whiteLineData = bbnames.filter((d)=>{return (d['Year of Birth']>= 2011)
                                                    && d["Child's First name"]=== chosenName
                                                    && d["Ethnicity"]=== "WHITE NON HISPANIC"
                                                    && d['Gender']=== chosenGender
                                                  });





      //sort
      nameLineData.sort((a,b) => d3.ascending(a['Year of Birth'], b['Year of Birth']));
      hispanicLineData.sort((a,b) => d3.ascending(a['Year of Birth'], b['Year of Birth']));
      asianLineData.sort((a,b) => d3.ascending(a['Year of Birth'], b['Year of Birth']));
      blackLineData.sort((a,b) => d3.ascending(a['Year of Birth'], b['Year of Birth']));
      whiteLineData.sort((a,b) => d3.ascending(a['Year of Birth'], b['Year of Birth']));





      // console.log(countDataList);
      //console.log(nameLineData)







      var groupbyNames = d3.nest() // nest function allows to group the calculation per level of a factor
        .key(function(d) { return d["Child's First name"];})
        .entries(bbnames);
        console.log(groupbyNames)
      var groupbyNamesNEW = groupbyNames.filter((d)=>d.key===chosenName)
      console.log(groupbyNamesNEW)
      groupbyNamesNEW.sort((a,b) => d3.ascending(a['Count'], b['Count']));


      // function getInputValue(){
      //       // Selecting the input element and get its value
      //       var inputVal = document.getElementById("myInput").value;

      //       // Displaying the value
      //       chosenName = inputVal.toUpperCase()
      //   }

    d3.select("#sendButton").on("click", function(d) {
        inputVal =  document.getElementById("myInput").value
        chosenName = inputVal.toUpperCase()

        groupbyNamesNEW = groupbyNames.filter((d)=>d.key===chosenName)
        groupbyNamesNEW.sort((a,b) => d3.ascending(a['Count'], b['Count']));

        if(groupbyNamesNEW.length === 0){
          alert("Sorry, this name has no record in our database, please type in another name.")
        }
        else{
          chosenGender = Object.values(Object.values(groupbyNamesNEW)[0])[1][0]["Gender"]
          updateOverallLineChart()
        }

      });





      //var v =  document.getElementById("myRange").value
      //Add options to selectRank
      var ranks=[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
      d3.select("#selectRank")
        .selectAll('rankOptions').data(ranks)
        .enter()
        .append('option')
        //.property('selected', d=>d[2])
        .text(d=>d)
        .attr('value', d=>d)




      function rankUpdate(rank) {
        console.log(chosenYear)
        nameBubbleData = []
        nameBubbleData = bbnames.filter((d)=>{return d["Rank"] <= rank && d["Year of Birth"] === chosenYear;});
        rankExtent = d3.extent(nameBubbleData, d => d['Rank']);
        rankScale = d3.scaleLinear().domain(rankExtent).range([bubblePadding, bubblePaddedHeight]);
        bubbleLayer.selectAll("*").remove();
        bubbleLegend.selectAll("*").remove();



        sim=d3.forceSimulation()


        sim.restart();

        //console.log(nameBubbleData)
        sim.nodes(nameBubbleData)
                  .force("ypos", d3.forceY().y(d => rankScale(d.Rank)).strength( 0.8 ) )//y-positioning force, set less than 1.0
                  .force("xpos", d3.forceX().x( d=> {
                    if (d["Ethnicity"] === "WHITE NON HISPANIC"&&d.Gender ==="MALE"){return bubblePaddedWidth*0.22}
                    if (d["Ethnicity"] === "WHITE NON HISPANIC"&&d.Gender ==="FEMALE"){return bubblePaddedWidth*0.28}
                    if (d["Ethnicity"] === "HISPANIC"&&d.Gender ==="MALE"){return bubblePaddedWidth*0.47}
                    if (d["Ethnicity"] === "HISPANIC"&&d.Gender ==="FEMALE"){return bubblePaddedWidth*0.53}
                    if (d["Ethnicity"] === "BLACK NON HISPANIC"&&d.Gender ==="MALE"){return bubblePaddedWidth*0.72}
                    if (d["Ethnicity"] === "BLACK NON HISPANIC"&&d.Gender ==="FEMALE"){return bubblePaddedWidth*0.78}
                    if (d["Ethnicity"] === "ASIAN AND PACIFIC ISLANDER"&&d.Gender ==="MALE"){return bubblePaddedWidth*0.94}
                    if (d["Ethnicity"] === "ASIAN AND PACIFIC ISLANDER"&&d.Gender ==="FEMALE"){return bubblePaddedWidth}
                    //if (d["Ethnicity"] === "WHITE NON HISPANIC"){return bubblePaddedWidth*0.25}
                    //if (d["Ethnicity"] === "HISPANIC"){return bubblePaddedWidth*0.5}
                    // if (d["Ethnicity"] === "BLACK NON HISPANIC"){return bubblePaddedWidth*0.75}
                    // if (d["Ethnicity"] === "ASIAN AND PACIFIC ISLANDER"){return bubblePaddedWidth}
                    else {return 0}}).strength( 0.8) )
                  .force("collision", d3.forceCollide()
                                        .radius(28)
                                        .iterations(2) )
                  .on("tick", render);



        //console.log(nameBubbleData)

      }

      //rankUpdate(10);

      d3.select("#selectRank").on("change", function(d) {
        rank =  d3.select(this).property("value")
        rankUpdate(rank);
        //console.log(rank)
      });

      var nameBubbleData = bbnames.filter((d)=>{return d["Rank"] <= rank && d["Year of Birth"] === chosenYear;});
      console.log(nameBubbleData)

      const bubbleEthnicity=["WHITE NON HISPANIC","HISPANIC","BLACK NON HISPANIC","ASIAN AND PACIFIC ISLANDER"]


      var rankExtent = d3.extent(nameBubbleData, d => d['Rank']);
      var rankScale = d3.scaleLinear().domain(rankExtent).range([bubblePadding, bubblePaddedHeight]);

      const colorScale = d3.scaleOrdinal()
                           .domain(bubbleEthnicity)
                           .range(["#FEF1E2","#E28E51","#934914","#FDDEBB"]);
      const genderColorScale = d3.scaleOrdinal()
                           .domain(["FEMALE","MALE"])
                           .range(["pink","#99ccff"]);



      // Update the chart for a new tick of the simulation
      function render(d) {
        //console.log(nameBubbleData)
        let labels = bubbleLegend.selectAll("text.label").data(nameBubbleData)
             .join(
               enter => enter.append("text")
                             .attr("class","label")
                             //.attr("stroke","#333")
                             .text(function(d){return d["Child's First name"]})
                             .attr("text-anchor", "middle")
                             .attr("alignment-baseline", "ideographic")
                             .on("click", clickBubble)


             )
             .attr("x", d => d.x).attr("y", d => d.y)

        let rankNums = bubbleLegend.selectAll("text.rankNum").data(nameBubbleData)
             .join(
               enter => enter.append("text")
                             .attr("class","rankNum")
                             //.attr("stroke","#333")
                             .text(d=> "#"+d["Rank"])
                             .attr("text-anchor", "middle")
                             .attr("alignment-baseline", "hanging")
                             .on("click", clickBubble)



             )
             .attr("x", d => d.x).attr("y", d => d.y)

        // Nodes
        let circles = bubbleLayer.selectAll("circle.node").data(nameBubbleData)
               .join(
                  enter => enter.append("circle")
                                .attr("class","node")
                                .attr("stroke", d=>genderColorScale(d.Gender))
                                .attr("stroke-width", 5)
                                .attr("stroke-alignment","outer")
                                .attr("r", 26)
                                .attr("cx", 0)
                                .attr("cy", 0)
                                .attr("fill", d => colorScale(d.Ethnicity))
                                .on("click", clickBubble)
                                // .call( d3.drag().on("start",dragstart)
                                //                 .on("drag",dragging)
                                //                 .on("end",dragend) )
                )
               //.attr("transform", d => `translate(${d.x},${d.y})`);
               .attr("cx", d => d.x).attr("cy", d => d.y);
      }


//Bar chart
const ethnicity = ["WHITE NON HISPANIC","HISPANIC","BLACK NON HISPANIC","ASIAN AND PACIFIC ISLANDER","OTHER/UNKNOWN"]

const barColorScale = d3.scaleOrdinal()
                     .domain(ethnicity)
                     .range(["#FEF1E2","#E28E51","#934914","#FDDEBB","#687980"]);
//Ethnicity scale
const ethnicityScale = d3.scaleBand().domain(ethnicity).range([barPadding+2, barChartWidth-50]).padding(0.08);
let ethnicityAxis= d3.axisBottom(ethnicityScale);


barLegend.attr("class", "x axis")
       .attr('transform', `translate(${barPadding},${barChartHeight+29})`)
       .call(ethnicityAxis)
       .selectAll("text")
       .attr("transform", "rotate(6)")
       .style("text-anchor", "middle")
       .style("font-size","9px");

// let birthsExtent= d3.extent(birthsByEthnicity, d=>d.value)
// let upperBound=d3.max(birthsByEthnicity, d=>d.value)
// console.log(upperBound);
let birthsScale = d3.scaleLinear().domain([0,42000]).range([barChartHeight,5])
let birthsAxis = d3.axisLeft(birthsScale);
barLegend.append("g")
        .attr('class', 'y axis')
        .attr('transform', `translate(${32},${-241})`)
        .call(birthsAxis);

//x label
barLayer.append('text')
         .attr('class', 'xlabel')
         .attr('x', 550)
         .attr('y', 280)
         .attr("text-anchor","middle")
         .attr("font-size","12px")
         .text('Ethinicity');

//Add options to the button
var years = d3.map(natality, d=>d["Birth Year"]).keys()
years.sort()
// console.log(years)

var sliderYear = d3.sliderHorizontal()
                   .min(d3.min(years))
                   .max(d3.max(years))
                   .step(1)
                   .width(400)
                   .tickFormat(d3.format('d'))
                   .tickValues(years)
                   .default('2011')
                   .on('onchange', val => {

                     update(String(val));
                      // console.log(value);
                    });


d3.select('#yearSlider')
  .append('svg')
  .attr('class', 'stillYears')
  .attr('width', '500')
  .attr('height', '100')
  .append('g')
  .attr('transform', 'translate(30,30)')
  .call(sliderYear);


  //a function that updates the chart
  function update(selectedGroup) {
    yearlyData = natality.filter((d)=>{return d["Birth Year"]===selectedGroup;})

    chosenYear = Number(selectedGroup)

    console.log(rank)

    rankUpdate(rank);



    //Births scale
    var birthsByEthnicity= d3.nest()
                             .key(d => d["Ethnicity of Mother"])
                             .rollup(d => d3.sum(d, g =>g["Births"]))
                             .entries(yearlyData);
    // console.log(birthsByEthnicity);

    //Add Bars
    barLayer.selectAll('rect.bar').data(birthsByEthnicity)
            .join('rect')
            .attr('class', 'bar')
            .attr('fill', d=>barColorScale(d.key))
            .attr('x', d => ethnicityScale(d.key))
            .attr('y', d => birthsScale(d.value))
            .attr('width', ethnicityScale.bandwidth()-50)
            .attr('height', d => barChartHeight-birthsScale(d.value))
            .attr('transform', `translate(${barPadding+25},${30})`);

    barLayer.selectAll('text.barNum').data(birthsByEthnicity)
            .join('text')
            .attr('class', 'barNum')
            .attr("text-anchor","middle")
            .attr("font-size","13px")
            .attr('x', d => ethnicityScale(d.key))
            .attr('y', d => birthsScale(d.value))
            .text(d =>d.value)
            .attr('transform', `translate(${barPadding+40},${28})`);
  }


  console.log(chosenYear)

  // When the button is changed, run the updateChart function
  update("2011");



  //chart title
  barLayer.append("text")
           .attr('class', 'title')
           .attr('x', 300)
           .attr('y', 16)
           .attr("text-anchor","middle")
           .attr("font-size","18px")
           .text('Number of Newborn Babies');

  ////////////////////////////////////////////////////////////////////////////////////////////////////////////
  //Line chart
  console.log(nameLineData)
  var yearScale = d3.scaleLinear().domain([2011, 2017]).range([linePadding,lineChartWidth])
  var maxCount = d3.max(bbnames, (d) => { return Math.max(d["Count"]); });
  console.log(maxCount)
  var countScale = d3.scaleLinear().domain([0,450]).range([lineChartHeight,linePadding])


  // Y axis
  let lineYAxis = d3.axisLeft(countScale)
  let lineGridlines = d3.axisLeft(countScale)
                        .tickSize(-lineChartWidth +linePadding)
                        .tickFormat("")
  lineLegend.append("g")
    .attr("class", "y axis")
    .attr("transform","translate(" + linePadding + ",0)")
    .call(lineYAxis)
  lineLegend.append("g")
    .attr("class", "y gridlines")
    .attr("transform","translate(" + linePadding + ",0)")
    .call(lineGridlines);

  let bottomAxis = d3.axisBottom(yearScale).ticks(7).tickFormat(d3.format('d'))
  // X axis
  lineLegend.append("g")
    .attr("transform", "translate(0," + lineChartHeight + ")")
    .call(bottomAxis);


  var lineGen = d3.line()
                  .x(function(d) {return yearScale(d['Year of Birth'])})
                  .y(function(d){return countScale(d['Count'])})
                  .curve(d3.curveMonotoneX);


      lineLayer.append("path")
         .datum(hispanicLineData)
         .attr("class","line")
         .attr("fill","none")
         .attr("stroke",d=> genderColorScale(chosenGender))
         .attr("stroke-width", 4)
         .attr("d",lineGen);

      lineLayer
        .selectAll("myPoints")
        .data(hispanicLineData)
        .enter()
        .append("circle")
          .attr("fill", d=> colorScale(d.Ethnicity))
          .attr("cx", d=> yearScale(d['Year of Birth']))
          .attr("cy", d=> countScale(d['Count']) )
          .attr("r", 6)
          .attr("stroke", d=> genderColorScale(chosenGender))
          .attr("stroke-width", 2)




      lineLayer.append("path")
         .datum(asianLineData)
         .attr("class","line")
         .attr("fill","none")
         .attr("stroke",d=> genderColorScale(chosenGender))
         .attr("stroke-width", 4)
         .attr("d",lineGen);
      lineLayer
        .selectAll("myPoints")
        .data(asianLineData)
        .enter()
        .append("circle")
          .attr("fill", d=> colorScale(d.Ethnicity))
          .attr("cx", d=> yearScale(d['Year of Birth']))
          .attr("cy", d=> countScale(d['Count']) )
          .attr("r", 6)
          .attr("stroke", d=> genderColorScale(chosenGender))
          .attr("stroke-width", 2)


      lineLayer.append("path")
         .datum(whiteLineData)
         .attr("class","line")
         .attr("fill","none")
         .attr("stroke",d=> genderColorScale(chosenGender))
         .attr("stroke-width", 4)
         .attr("d",lineGen);
      lineLayer
        .selectAll("myPoints")
        .data(whiteLineData)
        .enter()
        .append("circle")
          .attr("fill", d=> colorScale(d.Ethnicity))
          .attr("cx", d=> yearScale(d['Year of Birth']))
          .attr("cy", d=> countScale(d['Count']) )
          .attr("r", 6)
          .attr("stroke", d=> genderColorScale(chosenGender))
          .attr("stroke-width", 2)



      lineLayer.append("path")
         .datum(blackLineData)
         .attr("class","line")
         .attr("fill","none")
         .attr("stroke",d=> genderColorScale(chosenGender))
         .attr("stroke-width", 4)
         .attr("d",lineGen);
      lineLayer
        .selectAll("myPoints")
        .data(blackLineData)
        .enter()
        .append("circle")
          .attr("fill", d=> colorScale(d.Ethnicity))
          .attr("cx", d=> yearScale(d['Year of Birth']))
          .attr("cy", d=> countScale(d['Count']) )
          .attr("r", 6)
          .attr("stroke", d=> genderColorScale(chosenGender))
          .attr("stroke-width", 2)

 lineLayer
        .selectAll("myPoints")
        .data(asianLineData)
        .enter()
        .append("text")
          .attr("x",d=> yearScale(d['Year of Birth'])+10)
          .attr("y",d=> countScale(d['Count']))
          .text(d=> d['Count'])


      lineLayer
              .selectAll("myPoints")
              .data(hispanicLineData)
              .enter()
              .append("text")
                .attr("x",d=> yearScale(d['Year of Birth'])+10)
                .attr("y",d=> countScale(d['Count']))
                .text(d=> d['Count'])
      lineLayer
              .selectAll("myPoints")
              .data(whiteLineData)
              .enter()
              .append("text")
                .attr("x",d=> yearScale(d['Year of Birth'])+10)
                .attr("y",d=> countScale(d['Count']))
                .text(d=> d['Count'])
      lineLayer
        .selectAll("myPoints")
        .data(blackLineData)
        .enter()
        .append("text")
          .attr("x",d=> yearScale(d['Year of Birth'])+ 10)
          .attr("y",d=> countScale(d['Count'])+10)
          .text(d=> d['Count'])

      lineLayer.append("text")
           .attr('class', 'title')
           .attr('x', lineChartWidth/2 +linePadding/2)
           .attr('y', 17)
           .attr("text-anchor","middle")
           .attr("font-size",20)
           .text("Trend of \"" + capitalize(chosenName) + "\" from 2011 to 2017");

      lineLayer.append("text")
           .attr('x', 15)
           .attr('y', 35)
           .text("count")

      lineLayer
        .append("text")
          .attr("x",d=> lineChartWidth + 30)
          .attr("y",countScale(blackLineData[blackLineData.length -1]['Count']) + 10)
          .attr("text-anchor", "start")
          .text("Black")
          .attr("fill", )
  lineLayer
        .append("text")
          .attr("x",d=> lineChartWidth + 30)
          .attr("y",countScale(asianLineData[asianLineData.length -1]['Count'])-10)
          .attr("text-anchor", "start")
          .text("Asian")
          .attr("fill", )
          lineLayer
        .append("text")
          .attr("x",d=> lineChartWidth + 30)
          .attr("y",countScale(hispanicLineData[hispanicLineData.length -1]['Count']) -10)
          .attr("text-anchor", "start")
          .text("Hispanic")
          .attr("fill", )
          lineLayer
        .append("text")
          .attr("x",d=> lineChartWidth + 30)
          .attr("y",countScale(whiteLineData[whiteLineData.length - 1]['Count']) -10)
          .attr("text-anchor", "start")
          .text("White")
          .attr("fill", )

    // console.log(countScale(hispanicLineData[0]['Count']))







//   let mouseGroup = lineLayer.append("g");
//   let xMarker = mouseGroup.append("line")
//     .attr("id","xMarker")
//     .attr("fill","none")
//     .attr("stroke","black")
//     .attr("stroke-width",1)
//     .attr("y1",0)
//     .attr("y2",lineChartHeight)
//     .attr("visibility","hidden");

//   let valueMarker = mouseGroup.append("circle")
//     .attr("id","valueMarker")
//     .attr("fill","none")
//     .attr("stroke","black")
//     .attr("stroke-width",2)
//     .attr("r",10)
//     .attr("visibility","hidden");

//   let label = mouseGroup.append("text")
//     .attr("id","label")
//     .attr("visibility","hidden");


// let activeRegion = mouseGroup.append("rect")
//     .attr("id","activeRegion")
//     .attr("width",lineChartWidth)
//     .attr("height",lineChartHeight)
//     .attr("fill","none")
//     .attr("pointer-events","all");


//   let findDate = d3.bisector( d => d['Year of Birth'] ).right;

//   // activeRegion is now the top-most item (even if invisible), so it should always catch the mouse events and never clash
//   activeRegion.on("mouseover", function() {
//     // Show the marker and label when mousing over
//     xMarker.attr("visibility","");
//     valueMarker.attr("visibility","");
//     label.attr("visibility","");
//   });

//   activeRegion.on("mouseout", function() {
//     // Hide them when mousing out of chart
//     xMarker.attr("visibility","hidden");
//     valueMarker.attr("visibility","hidden");
//     label.attr("visibility","hidden");
//   });

//   activeRegion.on("mousemove", function(evt) {
//     let location = d3.pointer(evt);
//     let x = location[0];
//     let xDate = yearScale.invert(x);
//     let index = findDate(nameLineData, xDate);

//     let d = nameLineData[index];

//     let xPos = yearScale(d['Year of Birth'])
//     let yPos = countScale(d['Count']);

//     xMarker.attr("x1",xPos).attr("x2",xPos);
//     valueMarker.attr("cx",xPos).attr("cy",yPos);

//     let txt = "Rank:" + d['Rank']

//     label.text(txt);
//     if (yPos > lineChartHeight / 2.0 && xPos < lineChartWidth / 2.0) {
//       label.attr("x",xPos+ 10).attr("y", yPos - 40).attr("text-anchor","start");
//     }
//     else if (yPos > lineChartHeight / 2.0 && xPos > lineChartWidth / 2.0){
//       label.attr("x",xPos- 10).attr("y", yPos - 40).attr("text-anchor","end");
//     }
//     else if (yPos < lineChartHeight / 2.0 && xPos > lineChartWidth / 2.0){
//       label.attr("x",xPos- 10).attr("y", yPos - 40).attr("text-anchor","end");
//     }
//     else {
//       label.attr("x",xPos + 10).attr("y", yPos + 40).attr("text-anchor","start");
//     }
//   });





















    function clickBubble(event, d){
      //console.log(d['Year of Birth'] + d.Ethnicity )
      console.log(d)
      chosenName = d["Child's First name"]
      chosenEthnicity = d["Ethnicity"]
      chosenGender = d["Gender"]
      //hightlight bubble
      d3.select(this).transition()
        .attr("r", 36)
        .transition()
        .attr("r", 26)

      updateLineChart()
    }



    function updateOverallLineChart(){
      lineLayer.selectAll("*").remove();
      lineLegend.selectAll("*").remove();
      var hispanicLineData = bbnames.filter((d)=>{return (d['Year of Birth']>= 2011)
                                                    && d["Child's First name"]=== chosenName
                                                    && d["Ethnicity"]=== "HISPANIC"
                                                    && d['Gender']=== chosenGender
                                                  });
      var asianLineData = bbnames.filter((d)=>{return (d['Year of Birth']>= 2011)
                                                    && d["Child's First name"]=== chosenName
                                                    && d["Ethnicity"]=== "ASIAN AND PACIFIC ISLANDER"
                                                    && d['Gender']=== chosenGender
                                                  });
      var blackLineData = bbnames.filter((d)=>{return (d['Year of Birth']>= 2011)
                                                    && d["Child's First name"]=== chosenName
                                                    && d["Ethnicity"]=== "BLACK NON HISPANIC"
                                                    && d['Gender']=== chosenGender
                                                  });
      var whiteLineData = bbnames.filter((d)=>{return (d['Year of Birth']>= 2011)
                                                    && d["Child's First name"]=== chosenName
                                                    && d["Ethnicity"]=== "WHITE NON HISPANIC"
                                                    && d['Gender']=== chosenGender
                                                  });
      hispanicLineData.sort((a,b) => d3.ascending(a['Year of Birth'], b['Year of Birth']));
      asianLineData.sort((a,b) => d3.ascending(a['Year of Birth'], b['Year of Birth']));
      blackLineData.sort((a,b) => d3.ascending(a['Year of Birth'], b['Year of Birth']));
      whiteLineData.sort((a,b) => d3.ascending(a['Year of Birth'], b['Year of Birth']));


      var yearScale = d3.scaleLinear().domain([2011, 2017]).range([linePadding,lineChartWidth])
      var hispanicmaxCount = d3.max(hispanicLineData, (d) => { return Math.max(d["Count"]); });
      var asianmaxCount = d3.max(asianLineData, (d) => { return Math.max(d["Count"]); });
      var blackmaxCount = d3.max(blackLineData, (d) => { return Math.max(d["Count"]); });
      var whitemaxCount = d3.max(whiteLineData, (d) => { return Math.max(d["Count"]); });

      var maxList = [hispanicmaxCount,asianmaxCount,blackmaxCount,whitemaxCount];
      maxList = maxList.filter( Number );

      var totalMaxCount = Math.max(...maxList);
      console.log(maxList)
      console.log(totalMaxCount)

      var countScale = d3.scaleLinear().domain([0,totalMaxCount]).range([lineChartHeight,linePadding])


      // Y axis
      let lineYAxis = d3.axisLeft(countScale)
      let lineGridlines = d3.axisLeft(countScale)
                            .tickSize(-lineChartWidth +linePadding)
                            .tickFormat("")
      lineLegend.append("g")
        .attr("class", "y axis")
        .attr("transform","translate(" + linePadding + ",0)")
        .call(lineYAxis)
      lineLegend.append("g")
        .attr("class", "y gridlines")
        .attr("transform","translate(" + linePadding + ",0)")
        .call(lineGridlines);

      let bottomAxis = d3.axisBottom(yearScale).ticks(7).tickFormat(d3.format('d'))
      // X axis
      lineLegend.append("g")
        .attr("transform", "translate(0," + lineChartHeight + ")")
        .call(bottomAxis);





      lineGen = d3.line()
                      .x(function(d) {return yearScale(d['Year of Birth'])})
                      .y(function(d){return countScale(d['Count'])})
                      .curve(d3.curveMonotoneX);

      if(hispanicLineData.length>0){
        lineLayer.append("path")
         .datum(hispanicLineData)
         .attr("class","line")
         .attr("fill","none")
         .attr("stroke",d=> genderColorScale(chosenGender))
         .attr("stroke-width", 4)
         .attr("d",lineGen);

      lineLayer
        .selectAll("myPoints")
        .data(hispanicLineData)
        .enter()
        .append("circle")
          .attr("fill", d=> colorScale(d.Ethnicity))
          .attr("cx", d=> yearScale(d['Year of Birth']))
          .attr("cy", d=> countScale(d['Count']) )
          .attr("r", 6)
          .attr("stroke", d=> genderColorScale(chosenGender))
          .attr("stroke-width", 2)
      }//end of hispanic exist


      if(asianLineData.length>0){
        lineLayer.append("path")
         .datum(asianLineData)
         .attr("class","line")
         .attr("fill","none")
         .attr("stroke",d=> genderColorScale(chosenGender))
         .attr("stroke-width", 4)
         .attr("d",lineGen);
      lineLayer
        .selectAll("myPoints")
        .data(asianLineData)
        .enter()
        .append("circle")
          .attr("fill", d=> colorScale(d.Ethnicity))
          .attr("cx", d=> yearScale(d['Year of Birth']))
          .attr("cy", d=> countScale(d['Count']) )
          .attr("r", 6)
          .attr("stroke", d=> genderColorScale(chosenGender))
          .attr("stroke-width", 2)
      }//end of asian exist

      if(whiteLineData.length>0){
        lineLayer.append("path")
         .datum(whiteLineData)
         .attr("class","line")
         .attr("fill","none")
         .attr("stroke",d=> genderColorScale(chosenGender))
         .attr("stroke-width", 4)
         .attr("d",lineGen);
      lineLayer
        .selectAll("myPoints")
        .data(whiteLineData)
        .enter()
        .append("circle")
          .attr("fill", d=> colorScale(d.Ethnicity))
          .attr("cx", d=> yearScale(d['Year of Birth']))
          .attr("cy", d=> countScale(d['Count']) )
          .attr("r", 6)
          .attr("stroke", d=> genderColorScale(chosenGender))
          .attr("stroke-width", 2)

      }//end of white exist

      if(blackLineData.length>0){
        lineLayer.append("path")
         .datum(blackLineData)
         .attr("class","line")
         .attr("fill","none")
         .attr("stroke",d=> genderColorScale(chosenGender))
         .attr("stroke-width", 4)
         .attr("d",lineGen);
      lineLayer
        .selectAll("myPoints")
        .data(blackLineData)
        .enter()
        .append("circle")
          .attr("fill", d=> colorScale(d.Ethnicity))
          .attr("cx", d=> yearScale(d['Year of Birth']))
          .attr("cy", d=> countScale(d['Count']) )
          .attr("r", 6)
          .attr("stroke", d=> genderColorScale(chosenGender))
          .attr("stroke-width", 2)

      }//end of black exsit


      if(asianLineData.length>0){
        lineLayer
        .selectAll("myPoints")
        .data(asianLineData)
        .enter()
        .append("text")
          .attr("x",d=> yearScale(d['Year of Birth'])+10)
          .attr("y",d=> countScale(d['Count']))
          .text(d=> d['Count'])

        lineLayer
        .append("text")
          .attr("x",yearScale(asianLineData[asianLineData.length -1]['Year of Birth'])+40)
          .attr("y",countScale(asianLineData[asianLineData.length -1]['Count'])+10)
          .attr("text-anchor", "start")
          .text("Asian")



      }
      if(hispanicLineData.length>0){
        lineLayer
        .selectAll("myPoints")
        .data(hispanicLineData)
        .enter()
        .append("text")
          .attr("x",d=> yearScale(d['Year of Birth'])+10)
          .attr("y",d=> countScale(d['Count']))
          .text(d=> d['Count'])

        lineLayer
        .append("text")
          .attr("x",yearScale(hispanicLineData[hispanicLineData.length -1]['Year of Birth'])+40)
          .attr("y",countScale(hispanicLineData[hispanicLineData.length -1]['Count']) -10)
          .attr("text-anchor", "start")
          .text("Hispanic")

      }


      if(whiteLineData.length>0){
        lineLayer
        .selectAll("myPoints")
        .data(whiteLineData)
        .enter()
        .append("text")
          .attr("x",d=> yearScale(d['Year of Birth'])+10)
          .attr("y",d=> countScale(d['Count']))
          .text(d=> d['Count'])
          lineLayer
        .append("text")
          .attr("x",yearScale(whiteLineData[whiteLineData.length -1]['Year of Birth'])+40)
          .attr("y",countScale(whiteLineData[whiteLineData.length - 1]['Count']) -10)
          .attr("text-anchor", "start")
          .text("White")

      }



      if(blackLineData.length>0){
        lineLayer
        .selectAll("myPoints")
        .data(blackLineData)
        .enter()
        .append("text")
          .attr("x",d=> yearScale(d['Year of Birth'])+10)
          .attr("y",d=> countScale(d['Count']))
          .text(d=> d['Count'])

        lineLayer
        .append("text")
          .attr("x",yearScale(blackLineData[blackLineData.length -1]['Year of Birth'])+40)
          .attr("y",countScale(blackLineData[blackLineData.length -1]['Count']) + 10)
          .attr("text-anchor", "start")
          .text("Black")

      }



















      lineLayer.append("text")
           .attr('class', 'title')
           .attr('x', lineChartWidth/2 +linePadding/2)
           .attr('y', 17)
           .attr("text-anchor","middle")
           .attr("font-size",20)
           .text("Trend of \"" + capitalize(chosenName) + "\" from 2011 to 2017");

      lineLayer.append("text")
           .attr('x', 15)
           .attr('y', 35)
           .text("count")










    }









    function updateLineChart(){
      lineLayer.selectAll("*").remove();
      //update data
      nameLineData = bbnames.filter((d)=>{return (d['Year of Birth']>= 2011 && d['Year of Birth']<= 2017)
                                                    && d["Child's First name"]=== chosenName
                                                    && d["Ethnicity"]=== chosenEthnicity
                                                    && d['Gender']=== chosenGender
                                                  });

      //sort
      nameLineData.sort((a,b) => d3.ascending(a['Year of Birth'], b['Year of Birth']));


      lineGen = d3.line()
                      .x(function(d) {return yearScale(d['Year of Birth'])})
                      .y(function(d){return countScale(d['Count'])})
                      .curve(d3.curveMonotoneX);

      lineLayer.append("path")
         .datum(nameLineData)
         .attr("class","line")
         .attr("fill","none")
         .attr("stroke",d=> genderColorScale(chosenGender))
         .attr("stroke-width", 4)
         .attr("d",lineGen);

      lineLayer
        .selectAll("myPoints")
        .data(nameLineData)
        .enter()
        .append("circle")
          .attr("fill", d=> colorScale(d.Ethnicity))
          .attr("cx", d=> yearScale(d['Year of Birth']))
          .attr("cy", d=> countScale(d['Count']) )
          .attr("r", 6)
          .attr("stroke", d=> genderColorScale(chosenGender))
          .attr("stroke-width", 2)


      lineLayer.append("text")
           .attr('class', 'title')
           .attr('x', lineChartWidth/2 +linePadding/2)
           .attr('y', 17)
           .attr("text-anchor","middle")
           .attr("font-size",20)
           .text("Trend of \"" + capitalize(chosenName) + "\" among " + capitalize(chosenEthnicity) + " populations");




      lineLayer
        .selectAll("myPoints")
        .data(nameLineData)
        .enter()
        .append("text")
          .attr("x",d=> yearScale(d['Year of Birth']))
          .attr("y",d=> countScale(d['Count']) - 10)
          .text(d=> d['Count'])

      lineLayer.append("text")
           .attr('x', 15)
           .attr('y', 35)
           .text("count")



      let mouseGroup = lineLayer.append("g");
  let xMarker = mouseGroup.append("line")
    .attr("id","xMarker")
    .attr("fill","none")
    .attr("stroke","black")
    .attr("stroke-width",1)
    .attr("y1",0)
    .attr("y2",lineChartHeight)
    .attr("visibility","hidden");

  let valueMarker = mouseGroup.append("circle")
    .attr("id","valueMarker")
    .attr("fill","none")
    .attr("stroke","black")
    .attr("stroke-width",2)
    .attr("r",10)
    .attr("visibility","hidden");

  let label = mouseGroup.append("text")
    .attr("id","label")
    .attr("visibility","hidden");


let activeRegion = mouseGroup.append("rect")
    .attr("id","activeRegion")
    .attr("width",lineChartWidth)
    .attr("height",lineChartHeight)
    .attr("fill","none")
    .attr("pointer-events","all");


  let findDate = d3.bisector( d => d['Year of Birth'] ).right;

  // activeRegion is now the top-most item (even if invisible), so it should always catch the mouse events and never clash
  activeRegion.on("mouseover", function() {
    // Show the marker and label when mousing over
    xMarker.attr("visibility","");
    valueMarker.attr("visibility","");
    label.attr("visibility","");
  });

  activeRegion.on("mouseout", function() {
    // Hide them when mousing out of chart
    xMarker.attr("visibility","hidden");
    valueMarker.attr("visibility","hidden");
    label.attr("visibility","hidden");
  });

  activeRegion.on("mousemove", function(evt) {
    let location = d3.pointer(evt);
    let x = location[0];
    let xDate = yearScale.invert(x);
    let index = findDate(nameLineData, xDate);

    let d = nameLineData[index];

    let xPos = yearScale(d['Year of Birth'])
    let yPos = countScale(d['Count']);

    xMarker.attr("x1",xPos).attr("x2",xPos);
    valueMarker.attr("cx",xPos).attr("cy",yPos);

    let txt = "Rank:" + d['Rank']

    label.text(txt);
    if (yPos > lineChartHeight / 2.0 && xPos < lineChartWidth / 2.0) {
      label.attr("x",xPos+ 10).attr("y", yPos - 40).attr("text-anchor","start");
    }
    else if (yPos > lineChartHeight / 2.0 && xPos > lineChartWidth / 2.0){
      label.attr("x",xPos- 10).attr("y", yPos - 40).attr("text-anchor","end");
    }
    else if (yPos < lineChartHeight / 2.0 && xPos > lineChartWidth / 2.0){
      label.attr("x",xPos- 10).attr("y", yPos - 40).attr("text-anchor","end");
    }
    else {
      label.attr("x",xPos + 10).attr("y", yPos + 40).attr("text-anchor","start");
    }
  });




    }





      }//end of PROMISE



    requestData()
</script>


</body>
</html>
