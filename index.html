<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://d3js.org/d3-collection.v1.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Pangolin&display=swap');
    html{
      font-family: 'Pangolin', cursive;
      font-size: 15px;
    }

    text{
      font-family: 'Pangolin', cursive;
      font-size: 15px;
    }
    .linechart{
      display: flex;
      justify-content: center;
      right:10px;
    }
    .bubble{
      /* display: inline-block; */
      display: flex;
      justify-content: center;
      top: 10px;
      left:30px;

    }
    .bar{
      display: flex;
      justify-content: center;
      right:10px;
    }
    .select{
      /* position: absolute;
      top: 3px */
    }
    .my-legend{
      display: flex;
justify-content: center;
      top:65px;
      left:430px;
    }
    .slidecontainer{
      display: flex;
justify-content: center;
margin-top: 20px;
margin-bottom: 30px;

    }
    .my-legendA{
      display: flex;
justify-content: center;
      top:65px;
      left:430px;
    }
    .barandBubble{
      display: flex;
      justify-content: center;
    }

    span {
    display: block;
    float: left;
    border:none;
    width: 25%;
    }

    .my-legend .legend-title {
    text-align: left;
    margin-bottom: 8px;
    font-weight: bold;
    font-size: 90%;
    }
  .my-legend .legend-scale ul {
    margin: 0;
    padding: 0;
    float: left;
    list-style: none;
    }
  .my-legend .legend-scale ul li {
    display: block;
    float: left;
    width: 50px;
    margin-bottom: 6px;
    text-align: center;
    font-size: 80%;
    list-style: none;
    }
  .my-legend ul.legend-labels li span {
    display: block;
    float: left;
    height: 15px;
    width: 50px;
    }

  .my-legend a {
    color: #777;
    }


    .my-legendA .legend-titleA {
    text-align: left;
    margin-bottom: 8px;
    font-weight: bold;
    font-size: 90%;
    }
  .my-legendA .legend-scaleA ul {
    margin: 0;
    padding: 0;
    float: left;
    list-style: none;
    }
  .my-legendA .legend-scaleA ul li {
    display: block;
    float: left;
    width: 50px;
    margin-bottom: 6px;
    text-align: center;
    font-size: 80%;
    list-style: none;
    }
  .my-legendA ul.legend-labelA li span {
    display: block;
    float: left;
    height: 15px;
    width: 50px;
    }

  .my-legendA a {
    color: #777;
    }


  </style>
</head>
<body>
  <div style="text-align:center;">
    <h1>Baby Names and Births in NYC</h1>
  </div>

  <div class='my-legend' text-align="center">
  <div class='legend-title'></div>
  <div class='legend-scale'>
    <ul class='legend-labels'>
      <li><span style='background:#FEF1E2;'></span>White Non Hispanic</li>
      <li><span style='background:#E28E51;'></span>Hispanic</li>
      <li><span style='background:#934914;'></span>Black Non Hispanic</li>
      <li><span style='background:#FDDEBB;'></span>Asian and Pacific Islander</li>
      <li><span style='background:#687980;'></span>other</li>
    </ul>
  </div>
  </div>


  <div class='my-legendA' text-align="center">
  <div class='legend-titleA'></div>
  <div class='legend-scaleA'>
    <ul class='legend-labelA'>
      <li><span style='background:#99ccff;'></span>Male</li>
      <li><span style='background:#ffc0cb;'></span>Female</li>
    </ul>
  </div>
  </div>

  <div class="slidecontainer">
    <text>Choose the top</text>
   <select id="selectRank"><option value="none" selected disabled hidden>Select a Rank</option></select>
   <text>popular baby names</text>
  </div>


<div class="barandBubble">
  <div class="bubble" text-align="center"><svg id="bubbleGraph" height="350" width="800" style="background: #sff; " ></svg></div>

  <div class="bar">
    <div class="select">
      <select id="selectButton"></select>
    </div>
    <svg id="barChart" width="600" height="300"></svg>
  </div>
</div>

<div class="linechart">
  <div class="line" text-align="center"><svg id="lineGraph" width="460" height="400" style="background: #sff; " ></svg></div>
</div>

  <script>
  	const bubbleLayer = d3.select("#bubbleGraph").append("g");
  	const bubbleLegend = d3.select("#bubbleGraph").append("g");

    const bubbleWidth = d3.select("#bubbleGraph").attr("width");
    const bubbleHeight = d3.select("#bubbleGraph").attr("height");
    const bubblePadding = 50
    const bubblePaddedHeight = bubbleHeight - 2*bubblePadding
    const bubblePaddedWidth = bubbleWidth - 2*bubblePadding

    const barLayer = d3.select("#barChart").append("g");
    const barLegend = d3.select("#barChart").append("g");
    const barWidth = d3.select("#barChart").attr("width");
    const barHeight = d3.select("#barChart").attr("height");
    const barPadding = 30
    const barChartHeight = barHeight - 2*barPadding
    const barChartWidth = barWidth - 2*barPadding

    const requestData = async () => {
      const bbnames = await d3.csv("Popular_Baby_Names.csv", d3.autoType)
      //console.log(bbnames)
      const natality = await d3.csv('Natality.csv');
      //console.log(natality)

      const nameLineData = bbnames.filter((d)=>{return (d['Year of Birth']>= 2011 && d['Year of Birth']<= 2017)
                                                    //&& d['Rank']===1
                                                    && d["Child's First name"]==="EMMA"
                                                    //&& d["Ethnicity"]==="WHITE NON HISPANIC"
                                                    && d['Gender']==="FEMALE"
                                                  });

      //sort
      nameLineData.sort((a,b) => d3.ascending(a['Year of Birth'], b['Year of Birth']));
      // console.log(countDataList);
      //console.log(nameLineData)

      var chosenYear = 2017
      var rank = 3
      var chosenName = "EMMA"

      var groupbyNames = d3.nest() // nest function allows to group the calculation per level of a factor
        .key(function(d) { return d["Child's First name"];})
        .entries(bbnames);
        console.log(groupbyNames)
      const groupbyNamess = groupbyNames.filter((d)=>d.key==='EMMA')
      console.log(groupbyNamess)
      //var v =  document.getElementById("myRange").value
      //Add options to selectRank
      var ranks=[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
      d3.select("#selectRank")
        .selectAll('rankOptions').data(ranks)
        .enter()
        .append('option')
        //.property('selected', d=>d[2])
        .text(d=>d)
        .attr('value', d=>d)







      function rankUpdate(rank) {
        console.log(chosenYear)
        nameBubbleData = []
        nameBubbleData = bbnames.filter((d)=>{return d["Rank"] <= rank && d["Year of Birth"] === chosenYear;});
        rankExtent = d3.extent(nameBubbleData, d => d['Rank']);
        rankScale = d3.scaleLinear().domain(rankExtent).range([bubblePadding, bubblePaddedHeight]);
        bubbleLayer.selectAll("*").remove();
        bubbleLegend.selectAll("*").remove();



        sim=d3.forceSimulation()


        sim.restart();

        //console.log(nameBubbleData)
        sim.nodes(nameBubbleData)
                  .force("ypos", d3.forceY().y(d => rankScale(d.Rank)).strength( 0.8 ) )//y-positioning force, set less than 1.0
                  .force("xpos", d3.forceX().x( d=> {
                    if (d["Ethnicity"] === "WHITE NON HISPANIC"&&d.Gender ==="MALE"){return bubblePaddedWidth*0.22}
                    if (d["Ethnicity"] === "WHITE NON HISPANIC"&&d.Gender ==="FEMALE"){return bubblePaddedWidth*0.28}
                    if (d["Ethnicity"] === "HISPANIC"&&d.Gender ==="MALE"){return bubblePaddedWidth*0.47}
                    if (d["Ethnicity"] === "HISPANIC"&&d.Gender ==="FEMALE"){return bubblePaddedWidth*0.53}
                    if (d["Ethnicity"] === "BLACK NON HISPANIC"&&d.Gender ==="MALE"){return bubblePaddedWidth*0.72}
                    if (d["Ethnicity"] === "BLACK NON HISPANIC"&&d.Gender ==="FEMALE"){return bubblePaddedWidth*0.78}
                    if (d["Ethnicity"] === "ASIAN AND PACIFIC ISLANDER"&&d.Gender ==="MALE"){return bubblePaddedWidth*0.94}
                    if (d["Ethnicity"] === "ASIAN AND PACIFIC ISLANDER"&&d.Gender ==="FEMALE"){return bubblePaddedWidth}
                    //if (d["Ethnicity"] === "WHITE NON HISPANIC"){return bubblePaddedWidth*0.25}
                    //if (d["Ethnicity"] === "HISPANIC"){return bubblePaddedWidth*0.5}
                    // if (d["Ethnicity"] === "BLACK NON HISPANIC"){return bubblePaddedWidth*0.75}
                    // if (d["Ethnicity"] === "ASIAN AND PACIFIC ISLANDER"){return bubblePaddedWidth}
                    else {return 0}}).strength( 0.8) )
                  .force("collision", d3.forceCollide()
                                        .radius(28)
                                        .iterations(2) )
                  .on("tick", render);



        //console.log(nameBubbleData)

      }

      //rankUpdate(10);

      d3.select("#selectRank").on("change", function(d) {
        rank =  d3.select(this).property("value")
        rankUpdate(rank);
        //console.log(rank)
      });



      var nameBubbleData = bbnames.filter((d)=>{return d["Rank"] <= rank && d["Year of Birth"] === chosenYear;});
      console.log(nameBubbleData)

      const bubbleEthnicity=["WHITE NON HISPANIC","HISPANIC","BLACK NON HISPANIC","ASIAN AND PACIFIC ISLANDER"]


      var rankExtent = d3.extent(nameBubbleData, d => d['Rank']);
      var rankScale = d3.scaleLinear().domain(rankExtent).range([bubblePadding, bubblePaddedHeight]);

      const colorScale = d3.scaleOrdinal()
                           .domain(bubbleEthnicity)
                           .range(["#FEF1E2","#E28E51","#934914","#FDDEBB"]);
      const genderColorScale = d3.scaleOrdinal()
                           .domain(["FEMALE","MALE"])
                           .range(["pink","#99ccff"]);


      // Update the chart for a new tick of the simulation
      function render(d) {
        //console.log(nameBubbleData)
        let labels = bubbleLegend.selectAll("text.label").data(nameBubbleData)
             .join(
               enter => enter.append("text")
                             .attr("class","label")
                             //.attr("stroke","#333")
                             .text(function(d){return d["Child's First name"]})
                             .attr("text-anchor", "middle")
                             .attr("alignment-baseline", "ideographic")


             )
             .attr("x", d => d.x).attr("y", d => d.y)

        let rankNums = bubbleLegend.selectAll("text.rankNum").data(nameBubbleData)
             .join(
               enter => enter.append("text")
                             .attr("class","rankNum")
                             //.attr("stroke","#333")
                             .text(d=> "#"+d["Rank"])
                             .attr("text-anchor", "middle")
                             .attr("alignment-baseline", "hanging"),



             )
             .attr("x", d => d.x).attr("y", d => d.y)

        // Nodes
        let circles = bubbleLayer.selectAll("circle.node").data(nameBubbleData)
               .join(
                  enter => enter.append("circle")
                                .attr("class","node")
                                .attr("stroke", d=>genderColorScale(d.Gender))
                                .attr("stroke-width", 5)
                                .attr("stroke-alignment","outer")
                                .attr("r", 26)
                                .attr("cx", 0)
                                .attr("cy", 0)
                                .attr("fill", d => colorScale(d.Ethnicity))
                                .on("click", clickBubble)
                                // .call( d3.drag().on("start",dragstart)
                                //                 .on("drag",dragging)
                                //                 .on("end",dragend) )
                )
               //.attr("transform", d => `translate(${d.x},${d.y})`);
               .attr("cx", d => d.x).attr("cy", d => d.y);
      }


//Bar chart
const ethnicity = ["WHITE NON HISPANIC","HISPANIC","BLACK NON HISPANIC","ASIAN AND PACIFIC ISLANDER","OTHER/UNKNOWN"]

const barColorScale = d3.scaleOrdinal()
                     .domain(ethnicity)
                     .range(["#FEF1E2","#E28E51","#934914","#FDDEBB","#687980"]);
//Ethnicity scale
const ethnicityScale = d3.scaleBand().domain(ethnicity).range([barPadding+2, barChartWidth-50]).padding(0.08);
let ethnicityAxis= d3.axisBottom(ethnicityScale);


barLegend.attr("class", "x axis")
       .attr('transform', `translate(${barPadding},${barChartHeight+29})`)
       .call(ethnicityAxis)
       .selectAll("text")
       .attr("transform", "rotate(6)")
       .style("text-anchor", "middle")
       .style("font-size","9px");

// let birthsExtent= d3.extent(birthsByEthnicity, d=>d.value)
// let upperBound=d3.max(birthsByEthnicity, d=>d.value)
// console.log(upperBound);
let birthsScale = d3.scaleLinear().domain([0,42000]).range([barChartHeight,5])
let birthsAxis = d3.axisLeft(birthsScale);
barLegend.append("g")
        .attr('class', 'y axis')
        .attr('transform', `translate(${32},${-241})`)
        .call(birthsAxis);

//x label
barLayer.append('text')
         .attr('class', 'xlabel')
         .attr('x', 550)
         .attr('y', 280)
         .attr("text-anchor","middle")
         .attr("font-size","12px")
         .text('Ethinicity');

//Add options to the button
var years = d3.map(natality, d=>d["Birth Year"]).keys()
years.sort()
//console.log(years)

d3.select("#selectButton")
  .selectAll('yearOptions').data(years)
  .enter()
  .append('option')
  .text(d=>d)
  .attr('value', d=>d)


  //a function that updates the chart
  function update(selectedGroup) {
    yearlyData = natality.filter((d)=>{return d["Birth Year"]===selectedGroup;})

    chosenYear = Number(selectedGroup)

    console.log(rank)

    rankUpdate(rank);



    //Births scale
    var birthsByEthnicity= d3.nest()
                             .key(d => d["Ethnicity of Mother"])
                             .rollup(d => d3.sum(d, g =>g["Births"]))
                             .entries(yearlyData);
    // console.log(birthsByEthnicity);

    //Add Bars
    barLayer.selectAll('rect.bar').data(birthsByEthnicity)
            .join('rect')
            .attr('class', 'bar')
            .attr('fill', d=>barColorScale(d.key))
            .attr('x', d => ethnicityScale(d.key))
            .attr('y', d => birthsScale(d.value))
            .attr('width', ethnicityScale.bandwidth()-50)
            .attr('height', d => barChartHeight-birthsScale(d.value))
            .attr('transform', `translate(${barPadding+25},${30})`);

    barLayer.selectAll('text.barNum').data(birthsByEthnicity)
            .join('text')
            .attr('class', 'barNum')
            .attr("text-anchor","middle")
            .attr("font-size","13px")
            .attr('x', d => ethnicityScale(d.key))
            .attr('y', d => birthsScale(d.value))
            .text(d =>d.value)
            .attr('transform', `translate(${barPadding+40},${28})`);
  }


  console.log(chosenYear)

  // When the button is changed, run the updateChart function
  //update year
  d3.select("#selectButton").on("change", function(d) {
    var selectedOption = d3.select(this).property("value")
    update(selectedOption);
  });

  update("2011");

  //chart title
  barLayer.append("text")
           .attr('class', 'title')
           .attr('x', 300)
           .attr('y', 17)
           .attr("text-anchor","middle")
           .attr("font-size","18px")
           .text('Number of New Born Babies');

  ////////////////////////////////////////////////////////////////////////////////////////////////////////////
  //Line chart
  var margin = {top:10,right:30,bottom:30,left:60};
  var width = 460 - margin.left - margin.right;
  var height = 400 - margin.top - margin.bottom;
  const svg = d3.select("#lineGraph")
                      .append("svg")
                      .attr("width", width + margin.left + margin.right)
                      .attr("height", height + margin.top + margin.bottom)
                      .append("g")
                      .attr("transform",
                                "translate(" + margin.left + "," + margin.top + ")");
  const yearExtent = d3.extent(nameLineData,d=>d['Year of Birth'])
  const yearScale = d3.scaleLinear().domain([2011, 2017]).range([0,width])
  let bottomAxis = d3.axisBottom(yearScale).ticks(7)
  svg.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(bottomAxis);
  const countExtent = d3.extent(nameLineData,d=>d['Count'])
  const maxCount = d3.max(bbnames, (d) => { return Math.max(d[1]); });
  const countScale = d3.scaleLinear().domain([0,500]).range([0,height])
  //console.log(countExtent)
  var lineGen = d3.line()
                  .x(function(d) {return yearScale(d['Year of Birth'])})
                  .y(function(d){return countScale(d['Count'])})

                  .curve(d3.curveMonotoneX);


  // Add the lines

  svg.selectAll("myLines")
    .data(nameLineData)
    .enter()
    .append("path")
      .attr("d", lineGen )
      .attr("stroke", d=> colorScale(d.Ethnicity))
      .style("stroke-width", 4)
      .style("fill", "none")


  svg.append("path")
     .datum(nameLineData)
     .attr("class","line")
     .attr("fill","none")
     .attr("stroke","steelblue")
     .attr("d",lineGen);

  // svg.append("g")
  //      .selectAll("dot")
  //      .data(nameLineData)
  //      .enter()
  //      .append("circle")
  //        .attr("cx", function(d) {return yearScale(d['Year of Birth'])})
  //        .attr("cy", function(d){return countScale(d['Count'])})
  //        .attr("r", 5)
  //        .attr("fill", "#69b3a2")

  // Add the points
      svg
        // First we need to enter in a group
        .selectAll("myDots")
        .data(nameLineData)
        .enter()
          .append('g')
          .style("fill", d=> colorScale(d.Ethnicity))
        // Second we need to enter in the 'values' part of this group
        .selectAll("myPoints")
        .data(nameLineData)
        .enter()
        .append("circle")
          .attr("cx", d=> yearScale(d['Year of Birth']))
          .attr("cy", d=> countScale(d['Count']) )
          .attr("r", 5)
          .attr("stroke", "white")





  // Create a rect on top of the svg area: this rectangle recovers mouse position
    svg
      .append('rect')
      .style("fill", "none")
      .style("pointer-events", "all")
      .attr('width', width)
      .attr('height', height)
      .on('mouseover', mouseover)
      .on('mousemove', mousemove)
      .on('mouseout', mouseout);


    //   // This allows to find the closest X index of the mouse:
     var bisect = d3.bisector(d=> d['Year of Birth']).left;

    // // Create the circle that travels along the curve of chart
    var focus = svg.append('g')
      .append('circle')
        .style("fill", "none")
        .attr("stroke", "black")
        .attr('r', 8.5)
        .style("opacity", 0)

    // // Create the text that travels along the curve of chart
    var focusText = svg
      .append('g')
      .append('text')
        .style("opacity", 0)
        .attr("text-anchor", "left")
        .attr("alignment-baseline", "middle")



    //   svg.append("g")
    //   .selectAll("dot")
    //   .data(nameLineData)
    //   .enter()
    //   .append("circle")
    //   .attr("cx", function(d) {return yearScale(d['Year of Birth'])})
    //   .attr("cy", function(d){return countScale(d['Count'])})
    //   .attr("r", 5)
    //   .attr("fill", "#69b3a2")

    // Create a rect on top of the svg area: this rectangle recovers mouse position

      // svg.append('rect')
      // .style("fill", "none")
      // .style("pointer-events", "all")
      // .attr('width', width)
      // .attr('height', height)
      // .on('mouseover', mouseover)
      // .on('mousemove', mousemove)
      // .on('mouseout', mouseout);


    //What happens when the mouse move -> show the annotations at the right positions.
    function mouseover() {
      focus.style("opacity", 1)
      focusText.style("opacity",1)
    }

    function mousemove() {
      // recover coordinate we need
      var x0 = yearScale.invert(d3.pointer(this)[0]);
      var i = bisect(nameLineData, x0, 1);

      selectedData = nameLineData[i]
      //console.log(selectedData)
      focus.attr("cx", yearScale(selectedData["Year of Birth"]))
        .attr("cy", countScale(selectedData.Count))
      focusText.html("Year:" + selectedData["Year of Birth"] + "  ,  " + "Count:" + selectedData.Count)
        .attr("x", yearScale(selectedData["Year of Birth"])+15)
        .attr("y", countScale(selectedData.Count))
      }
    function mouseout() {
      focus.style("opacity", 0)
      focusText.style("opacity", 0)
    }

    function clickBubble(event, d){
      //console.log(d['Year of Birth'] + d.Ethnicity )
      console.log(d)
      //hightlight bubble
      d3.select(this).transition()
        .attr("r", 36)
      .transition()
      .attr("r", 26)

        

    }


          //let nameScale = d3.scaleLinear().domain()
          //var linegen = d3.line()
          //                .x(function(d) {return rankScale(d.rank)})
          //                .y(function(d) {return rankScale(d.rank)})



      }//end of PROMISE



    requestData()
</script>


</body>
</html>
